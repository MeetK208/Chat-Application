
<%- include('layouts/header.ejs', {logoutRoute: logoutRoute, homeRoute: homeRoute}); %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Application</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> -->
  <!-- integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> -->
<style>
    /* General Styling */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f4f4;
    }

    .start-head {
      text-align: center;
      margin-top: 20px;
      color: #333;
    }

    .chat-section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #chat-container {
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      overflow-y: scroll;
    }

    .list-group-item-dark {
      background-color: #343a40;
      color: #fff;
    }

    .user-list {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .user-list img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      object-fit: cover;
      margin-right: 10px;
    }

    .user-list:hover {
      background-color: #495057;
    }

    .form-control {
      border-radius: 0;
    }

    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      border-radius: 0;
    }

    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    .current-user-chat{
      text-align: right;
      margin: 10px;
      color: black;
    }
    
    .distance-user-chat{
      text-align: left;
      margin: 10px;
      color: red;
    }
    
    .online-status {
      background-color: green;
    }
    .offline-status {
      background-color: red;
    }
  </style>
</head>
<body>
  <h2 class="mb-4"> Welcome, <%= currentUser.name %>! </h2>
  <div class="row">
    <div class="col-md-3">
      <ul class="list-group">
        <% if (users.length > 0) { %>
          <% for (let i = 0; i < users.length; i++) { %>
            <li class="list-group-item list-group-item-dark user-list" data-id = "<%= users[i]._id %>">
              <div style="position: relative;">
                <img src="<%= "http://localhost:8080/" + users[i].image %>" alt="<%= users[i].name %>" style="width: 40px; height: 40px;">
                <span id="<%= users[i]._id %>-status" 
                      class="<%= users[i].is_online === "1" ? 'online-status' : 'offline-status' %>" 
                      style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;">
                </span>
              </div>
              <%= users[i].name %>
            </li>
          <% } %>
        <% } %>
      </ul>
    </div>
  
    <div class="col-md-9">
      <h3 class="start-head"> Click to Start The Chat</h3>
      <div class="chat-section" style="display:none;">
        <div id="chat-container">

          <div>
           <div>  <h5 class="current-user-chat"> Hiii </h5> </div>
           <div>  <h5 class="distance-user-chat"> Hiii </h5> </div>
          </div>

        </div>
        <form id="chat-form">
          <input type="text" name="message" placeholder="Enter message" id="message" class="form-control" required>
          <input type="submit" value="Send Message" class="btn btn-primary mt-2">
        </form>
      </div>
    </div>
  </div>
  


<script>

  const sender_id =  "<%= currentUser._id %>";
  var receiver_id; 
  
  var socket = io("http://localhost:3000/user-namespace",{
    auth: {
      token: sender_id,
      emailID: "<%= currentUser.email %>"
    }
  });

  // Toggle chat section
  $('.user-list').click(function() {
    $('.chat-section').toggle(); 
    var id = $(this).attr('data-id'); // This sets the receiver_id correctly when a user is clicked
    receiver_id = id;
    console.log("Receiver ID Set:", receiver_id);
  });

  socket.on('sendOnlineBroadcast', function(data) {
    $('#' + data.user_id + '-status').removeClass('offline-status');
    $('#' + data.user_id + '-status').addClass('online-status');
  });

  socket.on('sendOfflineBroadcast', function(data) {
    $('#' + data.user_id + '-status').removeClass('online-status');
    $('#' + data.user_id + '-status').addClass('offline-status');
  });
// Chat Save

  // Chat Save
  $(document).ready(function() {
    $('#chat-form').submit(function(event) {
      event.preventDefault();
      const message = $('#message').val();

      if (sender_id && receiver_id && message) {
        console.log({sender_id, receiver_id, message});

        fetch('/api/v1/chat/save-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sender_id: sender_id,
            receiver_id: receiver_id,
            message: message
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log(data);
            $('#message').val('');

            // Append the message to the chat container
            let chat = data.data.message;
            let chatClass = (data.data.sender_id === sender_id) ? 'current-user-chat' : 'other-user-chat';
            let html = `
              <div>
                <h5 class="${chatClass}">${chat}</h5>
              </div>
            `;
            $('#chat-container').append(html);
            $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
          } else {
            console.log("Failed to save chat:", data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      } else {
        console.log("Sender or Receiver ID is missing, or message is empty.");
      }
    });
  });

</script>

<%- include('layouts/footer.ejs'); %>

</body>
</html>
